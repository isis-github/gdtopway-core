wechatJSAPIList=ShareContent&&Environment===SystemEnvironment.name.PRO?["onMenuShareAppMessage"]:undefined;$(function(){var k=$("#hCustomerId").val(),b=$("#hCreditorId").val(),l=$("#hDebtorId").val();var a=$("#divDebtorLiabilityTips");wx.ready(function(){wx.onMenuShareAppMessage(ShareContent)});if($("#hStatus").val()===YcLoanIouStatus.name.Pending){if(k===b&&$("#hDebtorIsAuthenticated").val()!=="TRUE"){alert("借款人信息未通过实名认证，请知悉")}}var e=function(){$.appAjax({url:"/m/iou/ispaid",data:{id:$("#LoanIOUId").val()},executeBeforeSendFunc:false,onBeforeSend:function(){$.showLoading("正在查询支付结果...");$(".weui-toast").animate({opacity:0},0);setTimeout(function(){$(".weui-toast").animate({opacity:1},150)},250)},onSuccess:function(m){if(m.result){location.href=location.pathname}else{alert("未查到支付信息<br />若确认已支付，请1分钟后再查询支付结果");$("#hPaying").val("FALSE")}}})};var j=function(){if($("#hPaying").val()==="TRUE"){e()}else{if(k===l&&$("#hStatus").val()===YcLoanIouStatus.name.Pending&&$("#hIsPaid").val()!=="TRUE"){loadUrl("支付服务费","/m/payment/index/"+encodeParameters($("#LoanIOUId").val()),function(m){payment.init(function(n){if(n==="4004"){$("#divMobilePay").show()}else{location.href=location.pathname}})})}}};j();var g=function(m){loadUrl("电子签名","/m/customer/signature",function(n){signature.init(function(){if(n.find("#formCustomerSignature #hIsValidPassword").val()==="TRUE"){$("#hIsValidPassword").val(n.find("#formCustomerSignature #hIsValidPassword").val());var o=n.find("#formCustomerSignature #hSignatureImageUrl").val();$("#imgCreditorSignatureImage").attr({src:o});$("#hHasSignatured").val("TRUE");m&&m()}})})};var h=function(m){if(m){loadUrl("电子签名","/attachment/qiniu/viewurl?url="+m+"&title=电子签名",function(n){n.find("img").css({border:"1px solid #dedede",width:"calc(100% - 2px)"})})}};var i=function(o,m){if($("#hIsValidPassword").val()==="TRUE"){$.appAjax({url:"/m/iou/updateextenstatus",data:{id:o,status:m},onSuccess:function(p){handleAjaxResult(p,function(){location.href=location.pathname})}})}else{var n=null;switch(m){case YcLoanIouExtenStatus.Cancelled:n=CheckPasswordTpisType.CancelIOUExten;break;case YcLoanIouExtenStatus.Rejected:n=CheckPasswordTpisType.RejectIOUExten;break;case YcLoanIouExtenStatus.Effecting:n=CheckPasswordTpisType.EffectIOUExten;break}loadUrl("输入交易密码","/m/customer/checkpassword/"+encodeParameters(n),function(p){checkPassword.init(function(){if(p.find("#formCheckPassword #hIsValidPassword").val()==="TRUE"){$("#hIsValidPassword").val(p.find("#formCheckPassword #hIsValidPassword").val());i(o,m)}})})}};var d=function(){if($("#hIsValidPassword").val()==="TRUE"){$("#formUpdateStatus").submit()}else{var m=$("#Status").val(),n=null;switch(m){case YcLoanIouStatus.name.Deleted:n=CheckPasswordTpisType.DeleteIOU;break;case YcLoanIouStatus.name.Effecting:n=CheckPasswordTpisType.EffectIOU;break;case YcLoanIouStatus.name.Destroyed:n=CheckPasswordTpisType.DestroyIOU;break}loadUrl("输入交易密码","/m/customer/checkpassword/"+encodeParameters(n),function(o){checkPassword.init(function(){if(o.find("#formCheckPassword #hIsValidPassword").val()==="TRUE"){$("#hIsValidPassword").val(o.find("#formCheckPassword #hIsValidPassword").val());$("#formUpdateStatus").submit()}})})}};$("#btnQRCode").on({click:function(){$("#divQRCode").show();$("body").addClass("overflow-y")}});$("#btnQRCodeClose").on({click:function(){$("#divQRCode").hide();$("body").removeClass("overflow-y")}});$("#btnNewUserClose").on({click:function(){$("#divNewUser").hide();$("body").removeClass("overflow-y")}});$("#btnUnpaidRefresh").on({click:function(){location.href=location.pathname}});$("#btnMobilePayClose").on({click:function(){$("#divMobilePay").hide();$("body").removeClass("overflow-y")}});$("#imgDebtorHeadImage").on({click:function(){if(k===b){loadUrl("他的负债","/m/debt/liabilitybrief/"+encodeParameters(l))}}});var f=[];if(k===b){if($("#hIsSynchronizedContract").val()==="TRUE"&&$("#hStatus").val()===YcLoanIouStatus.name.Effecting&&parseDatetime($("#hFinalRepaymentDate").val())<today){f.push({text:"仲裁申请",onClick:function(){location.href="/m/iou/arbitration/"+encodeParameters($("#LoanIOUId").val())}})}}else{if(k===l){}}if(f.length){$("#linkMore").on({click:function(){$.appActions("请选择",f)}}).show()}var c=function(){var m=parseInt(a.css("top"))===-15?-20:-15;a.animate({top:m+"px"},400,c)};if(k===b){a.parent().css({position:"relative"});a.show();c()}$("#imgCreditorSignatureImage").on({click:function(){if(k===b){g()}else{h($(this).attr("src"))}}});$("#imgDebtorSignatureImage").on({click:function(){h($(this).attr("src"))}});$("#linkAgreement").on({click:function(){$.appActions("请选择",[{text:"居间服务协议",onClick:function(){location.href="/m/agreement/intermedia/"+$("#linkAgreement").data("intermediaversion")+"/"+encodeParameters($("#LoanIOUId").val())}},{text:"借款协议",onClick:function(){location.href="/m/agreement/iou/"+$("#linkAgreement").data("iouversion")+"/"+encodeParameters($("#LoanIOUId").val())}}])}});$("#tbExtens a").on({click:function(){var v=$(this),m=v.data("id"),x=v.data("canupdate")==="TRUE";var n=$("#exten_"+m+' [name="ExtenNumber"]').val(),r=$("#exten_"+m+' [name="Amount"]').val(),w=$("#exten_"+m+' [name="AnnualInterestRate"]').val(),A=$("#exten_"+m+' [name="Interest"]').val(),q=$("#exten_"+m+' [name="OldRepaymentDate"]').val(),p=$("#exten_"+m+' [name="NewRepaymentDate"]').val(),z=$("#exten_"+m+' [name="ExtenVersion"]').val(),s=$("#exten_"+m+' [name="Remark"]').val(),o=$("#exten_"+m+' [name="Status"]').val(),t='<div class="weui-form-preview"><div class="weui-form-preview__hd"><label class="weui-form-preview__label">展期至</label><label class="weui-form-preview__value text-dark">'+p+'</label></div><div class="weui-form-preview__bd"><div class="weui-form-preview__item"><label class="weui-form-preview__label">原到期日</label><span class="weui-form-preview__value text-dark">'+q+'</span></div><div class="weui-form-preview__item"><label class="weui-form-preview__label">展期天数</label><span class="weui-form-preview__value text-dark">'+((parseDatetime(p)-parseDatetime(q))/daysTime)+'<span class="text-xs ml5">天</span></span></div><div class="weui-form-preview__item mt20"><label class="weui-form-preview__label">展期本金</label><span class="weui-form-preview__value text-dark">'+r+'<span class="text-xs ml5">元</span></span></div><div class="weui-form-preview__item"><label class="weui-form-preview__label">年化利率</label><span class="weui-form-preview__value text-dark">'+w+'<span class="text-xs ml5">%</span></span></div><div class="weui-form-preview__item"><label class="weui-form-preview__label">利息</label><span class="weui-form-preview__value text-dark">'+A+'<span class="text-xs ml5">元</span></span></div><div class="weui-form-preview__item"><label class="weui-form-preview__label">备注</label><span class="weui-form-preview__value text-dark">'+(s?s:"-")+"</span></div>"+(!x&&o===YcLoanIouExtenStatus.name.Effecting?'<div class="weui-form-preview__item mt20"><label class="weui-form-preview__label">电子协议</label><span class="weui-form-preview__value"><a href="/m/agreement/exten/'+z+"/"+encodeParameters(m)+'" class="text-xs">点击查看</a></span></div>':"")+"</div></div>";var u=[{text:"确定",className:"primary",onClick:function(){viewUtility.closeSubview()}}];if(x){if(k===b){u=[{text:"返回",onClick:function(){viewUtility.closeSubview()}},{text:"取消展期",className:"primary",onClick:function(){viewUtility.closeSubview();i(m,YcLoanIouExtenStatus.Cancelled)}}]}else{if(k===l){u=[{text:"返回",onClick:function(){viewUtility.closeSubview()}},{text:"拒绝展期",onClick:function(){viewUtility.closeSubview();i(m,YcLoanIouExtenStatus.Rejected)}},{text:"确认展期",className:"primary",onClick:function(){viewUtility.closeSubview();i(m,YcLoanIouExtenStatus.Effecting)}}]}}}var y=$.modal({title:"展期信息",text:t,buttons:u});viewUtility.openSubview(y)}});if($('#tbExtens a[data-canupdate="TRUE"]').length){$("body").animate({scrollTop:$(document).height()-$(window).height()},$(window).scrollTop()<=10?250:0,function(){$('#tbExtens a[data-canupdate="TRUE"]').click()})}$("#divAction button").on({click:function(){var s=$(this);if(s.attr("id")==="btnExtend"){location.href="/m/iou/extend/"+encodeParameters($("#LoanIOUId").val())}else{if(s.attr("id")==="btnPay"){j()}else{var q=s.data("status");$("#Status").val(q);if(q===YcLoanIouStatus.name.Destroyed){var p=today.toFormat("yyyy-MM-dd"),o=parseDatetime($("#hBorrowingDate").val()).toFormat("yyyy-MM-dd"),m=parseDatetime($("#hFinalRepaymentDate").val()),r='<div class="weui-cells weui-cells_form"><div class="weui-cell weui-cell_select"><div class="weui-cell__bd"><input id="tbRealRepaymentDate" class="form-control select" type="text" placeholder="请选择实际还款日期" value="'+(m<today?"":p)+'" data-clear="false" data-min="'+o+'" data-max="'+p+'" /></div></div></div><div class="weui-cells__tips"><span class="fa fa-exclamation-circle mr5"></span><span id="spanRealRepaymentDate" class="text-xs">无逾期</span></div><div class="weui-flex mt20"><button id="btnSubmit" type="button" class="btn btn-primary">确定撕毁凭证</button></div>';var u=$.modal({title:"确定实际还款日期",text:r,buttons:[]});viewUtility.openSubview(u);var v=$('<button type="button" class="weui-dialog__close">&times;</button>').on({click:function(){$.closeModal();viewUtility.closeSubview()}});u.find(".weui-dialog__hd").append(v);u.find(".weui-dialog__bd").addClass("text-left");var n=u.find("#tbRealRepaymentDate");var w=u.find("#spanRealRepaymentDate");var t=function(){var x=Math.max((parseDatetime(n.val())-m)/daysTime,0);if(!isNaN(x)){if(x===0){w.html("无逾期").parent().removeClass("text-danger")}else{w.html("逾期"+x+"天").parent().addClass("text-danger")}}else{w.html("请先选择实际还款日期").parent().removeClass("text-danger")}};t();n.appCalendar({executeOpenFunc:false,executeCloseFunc:false,onClose:t}).change();u.find("#btnSubmit").on({click:function(){if(n.val()){$("#RealRepaymentDate").val(n.val());if($("#formUpdateStatus").valid()){$.closeModal();if(k===b&&$("#hStatus").val()===YcLoanIouStatus.name.Pending&&$("#hHasSignatured").val()!=="TRUE"){g(d)}else{d()}}}}})}else{if(k===b&&$("#hStatus").val()===YcLoanIouStatus.name.Pending&&$("#hHasSignatured").val()!=="TRUE"){g(d)}else{d()}}}}}});$("#linkCheckIsPaid").on({click:e});$("#formUpdateStatus").appSubmit({onSuccess:function(m){handleAjaxResult(m,function(){$.showLoading("正在刷新凭证 ...");$(".weui-toast").animate({opacity:0},0);setTimeout(function(){$(".weui-toast").animate({opacity:1},150)},250);setTimeout(function(){location.href=location.pathname},500)})}})});